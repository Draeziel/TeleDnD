generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ContentSource {
  id       String    @id @default(uuid())
  name     String    @unique
  classes  Class[]
  features Feature[]
  choices  Choice[]
  races    Race[]
  backgrounds Background[]
  items    Item[]
  skills   Skill[]

  @@map("content_sources")
}

model Class {
  id              String              @id @default(uuid())
  name            String              @unique
  contentSourceId String
  contentSource   ContentSource       @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  classFeatures   ClassFeature[]
  savingThrowProficiencies ClassSavingThrowProficiency[]
  characters      Character[]
  drafts          CharacterDraft[]

  @@map("classes")
}

model User {
  id                 String          @id @default(uuid())
  telegramId         String          @unique
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  ownedCharacters    Character[]
  createdSessions    Session[]       @relation("SessionCreator")
  gmSessions         Session[]       @relation("SessionGM")
  sessionPlayers     SessionPlayer[]
  monsterTemplates   MonsterTemplate[]

  @@map("users")
}

model Feature {
  id                 String             @id @default(uuid())
  name               String             @unique
  description        String?
  contentSourceId    String
  contentSource      ContentSource      @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  classFeatures      ClassFeature[]
  raceFeatures       RaceFeature[]
  backgroundFeatures BackgroundFeature[]

  @@map("features")
}

model ClassFeature {
  id            String  @id @default(uuid())
  classId       String
  featureId     String
  levelRequired Int     @default(1)
  class         Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  feature       Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([classId, featureId])
  @@map("class_features")
}

model Choice {
  id                    String                @id @default(uuid())
  contentSourceId       String
  contentSource         ContentSource         @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  sourceType            String
  sourceId              String
  chooseCount           Int                   @default(1)
  optionsJson           Json
  characterChoices      CharacterChoice[]
  characterDraftChoices CharacterDraftChoice[]

  @@map("choices")
}

model Race {
  id              String         @id @default(uuid())
  name            String         @unique
  contentSourceId String
  contentSource   ContentSource  @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  raceFeatures    RaceFeature[]
  characters      Character[]
  drafts          CharacterDraft[]

  @@map("races")
}

model Item {
  id              String         @id @default(uuid())
  name            String         @unique
  description     String?
  slot            String?
  contentSourceId String
  contentSource   ContentSource  @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  characterItems  CharacterItem[]

  @@map("items")
}

model CharacterItem {
  id          String    @id @default(uuid())
  characterId String
  itemId      String
  equipped    Boolean   @default(false)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  item        Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([characterId, itemId])
  @@map("character_items")
}

model Skill {
  id              String                        @id @default(uuid())
  name            String                        @unique
  ability         String
  contentSourceId String?
  contentSource   ContentSource?                @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  proficiencies   CharacterSkillProficiency[]

  @@map("skills")
}

model ClassSavingThrowProficiency {
  id        String @id @default(uuid())
  classId   String
  ability   String
  class     Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, ability])
  @@map("class_saving_throw_proficiencies")
}

model CharacterSkillProficiency {
  id          String     @id @default(uuid())
  characterId String
  skillId     String
  character   Character  @relation(fields: [characterId], references: [id], onDelete: Cascade)
  skill        Skill      @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([characterId, skillId])
  @@map("character_skill_proficiencies")
}

model RaceFeature {
  id        String  @id @default(uuid())
  raceId    String
  featureId String
  race      Race    @relation(fields: [raceId], references: [id], onDelete: Cascade)
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([raceId, featureId])
  @@map("race_features")
}

model Background {
  id              String         @id @default(uuid())
  name            String         @unique
  contentSourceId String
  contentSource   ContentSource  @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  backgroundFeatures BackgroundFeature[]
  characters      Character[]
  drafts          CharacterDraft[]
  @@map("backgrounds")
}

model Modifier {
  id         String   @id @default(uuid())
  sourceType String
  sourceId   String
  target     String
  targetKey  String?
  operation  String
  value      Int?
  createdAt  DateTime @default(now())

  @@index([sourceType, sourceId], name: "modifiers_source_idx")
  @@map("modifiers")
}

model BackgroundFeature {
  id           String     @id @default(uuid())
  backgroundId String
  featureId    String
  background   Background @relation(fields: [backgroundId], references: [id], onDelete: Cascade)
  feature      Feature    @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([backgroundId, featureId])
  @@map("background_features")
}

model AbilityScoreSet {
  id        String      @id @default(uuid())
  method    String      // "standard_array", "point_buy", "manual", "roll"
  str       Int
  dex       Int
  con       Int
  int       Int
  wis       Int
  cha       Int
  characters Character[]
  drafts    CharacterDraft[]

  @@map("ability_score_sets")
}

model Character {
  id               String             @id @default(uuid())
  name             String
  level            Int                @default(1)
  ownerUserId      String?
  classId          String
  raceId           String?
  backgroundId     String?
  abilityScoreSetId String?
  owner            User?              @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  class            Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  race             Race?              @relation(fields: [raceId], references: [id], onDelete: SetNull)
  background       Background?        @relation(fields: [backgroundId], references: [id], onDelete: SetNull)
  abilityScores    AbilityScoreSet?   @relation(fields: [abilityScoreSetId], references: [id], onDelete: SetNull)
  characterChoices CharacterChoice[]
  inventory        CharacterItem[]
  skillProficiencies CharacterSkillProficiency[]
  sessionCharacters SessionCharacter[]

  @@index([ownerUserId])
  @@map("characters")
}

model Session {
  id              String              @id @default(uuid())
  name            String
  gmUserId        String
  createdByUserId String
  joinCode        String              @unique
  initiativeLocked Boolean            @default(false) @map("initiative_locked")
  encounterActive Boolean             @default(false) @map("encounter_active")
  combatRound     Int                 @default(1) @map("combat_round")
  activeTurnSessionCharacterId String? @map("active_turn_session_character_id")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  gmUser          User                @relation("SessionGM", fields: [gmUserId], references: [id], onDelete: Cascade)
  createdByUser   User                @relation("SessionCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  players         SessionPlayer[]
  characters      SessionCharacter[]
  monsters        SessionMonster[]
  events          SessionEvent[]

  @@index([gmUserId])
  @@index([createdByUserId])
  @@map("sessions")
}

model MonsterTemplate {
  id                 String          @id @default(uuid())
  name               String
  armorClass         Int             @map("armor_class")
  maxHp              Int             @map("max_hp")
  initiativeModifier Int             @default(0) @map("initiative_modifier")
  challengeRating    String?         @map("challenge_rating")
  source             String?
  scope              String          @default("PERSONAL")
  ownerUserId        String?         @map("owner_user_id")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  owner              User?           @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  sessionMonsters    SessionMonster[]

  @@index([scope])
  @@index([ownerUserId])
  @@map("monster_templates")
}

model SessionMonster {
  id                String           @id @default(uuid())
  sessionId         String
  monsterTemplateId String?          @map("monster_template_id")
  nameSnapshot      String           @map("name_snapshot")
  currentHp         Int              @map("current_hp")
  maxHpSnapshot     Int              @map("max_hp_snapshot")
  initiative        Int?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  session           Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  monsterTemplate   MonsterTemplate? @relation(fields: [monsterTemplateId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([monsterTemplateId])
  @@map("session_monsters")
}

model SessionEvent {
  id              String    @id @default(uuid())
  sessionId       String
  type            String
  message         String
  actorTelegramId String
  createdAt       DateTime  @default(now())
  session         Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("session_events")
}

model SessionPlayer {
  id        String      @id @default(uuid())
  sessionId String
  userId    String
  role      String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  session   Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([userId])
  @@map("session_players")
}

model SessionCharacter {
  id        String                 @id @default(uuid())
  sessionId String
  characterId String
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  session   Session                @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  character Character              @relation(fields: [characterId], references: [id], onDelete: Cascade)
  state     SessionCharacterState?
  effects   SessionEffect[]

  @@unique([sessionId, characterId])
  @@index([characterId])
  @@map("session_characters")
}

model SessionCharacterState {
  id                 String           @id @default(uuid())
  sessionCharacterId String           @unique
  currentHp          Int              @default(0)
  maxHpSnapshot      Int              @default(0)
  tempHp             Int?
  initiative         Int?
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  sessionCharacter   SessionCharacter @relation(fields: [sessionCharacterId], references: [id], onDelete: Cascade)

  @@map("session_character_states")
}

model SessionEffect {
  id                 String           @id @default(uuid())
  sessionCharacterId String
  effectType         String
  duration           String
  payload            Json
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  sessionCharacter   SessionCharacter @relation(fields: [sessionCharacterId], references: [id], onDelete: Cascade)

  @@index([sessionCharacterId])
  @@map("session_effects")
}

model CharacterChoice {
  id             String    @id @default(uuid())
  characterId    String
  choiceId       String
  selectedOption String
  character      Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  choice         Choice    @relation(fields: [choiceId], references: [id], onDelete: Cascade)

  @@unique([characterId, choiceId])
  @@map("character_choices")
}

model CharacterDraft {
  id                    String                @id @default(uuid())
  name                  String
  level                 Int                   @default(1)
  classId               String?
  raceId                String?
  backgroundId          String?
  abilityScoreSetId     String?
  class                 Class?                @relation(fields: [classId], references: [id], onDelete: SetNull)
  race                  Race?                 @relation(fields: [raceId], references: [id], onDelete: SetNull)
  background            Background?           @relation(fields: [backgroundId], references: [id], onDelete: SetNull)
  abilityScores         AbilityScoreSet?      @relation(fields: [abilityScoreSetId], references: [id], onDelete: SetNull)
  createdAt             DateTime              @default(now())
  characterDraftChoices CharacterDraftChoice[]

  @@map("character_drafts")
}

model CharacterDraftChoice {
  id             String         @id @default(uuid())
  draftId        String
  choiceId       String
  selectedOption String?
  draft          CharacterDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  choice         Choice         @relation(fields: [choiceId], references: [id], onDelete: Cascade)

  @@unique([draftId, choiceId])
  @@map("character_draft_choices")
}
