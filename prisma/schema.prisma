generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ContentSource {
  id       String    @id @default(uuid())
  name     String    @unique
  classes  Class[]
  features Feature[]
  choices  Choice[]
  races    Race[]
  backgrounds Background[]
  items    Item[]
  skills   Skill[]
  actions  Action[]
  spells   Spell[]

  @@map("content_sources")
}

model Class {
  id              String              @id @default(uuid())
  name            String              @unique
  contentSourceId String
  rulesVersion    String              @default("v1")
  sourceRef       String?             @unique
  contentSource   ContentSource       @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  classFeatures   ClassFeature[]
  levelProgressions ClassLevelProgression[]
  savingThrowProficiencies ClassSavingThrowProficiency[]
  characters      Character[]
  drafts          CharacterDraft[]

  @@map("classes")
}

model User {
  id                 String          @id @default(uuid())
  telegramId         String          @unique
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  ownedCharacters    Character[]
  createdSessions    Session[]       @relation("SessionCreator")
  gmSessions         Session[]       @relation("SessionGM")
  sessionPlayers     SessionPlayer[]
  monsterTemplates   MonsterTemplate[]

  @@map("users")
}

model Feature {
  id                 String             @id @default(uuid())
  name               String             @unique
  description        String?
  contentSourceId    String
  rulesVersion       String             @default("v1")
  sourceRef          String?
  contentSource      ContentSource      @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  classFeatures      ClassFeature[]
  classLevelProgressions ClassLevelProgression[]
  raceFeatures       RaceFeature[]
  backgroundFeatures BackgroundFeature[]
  actions            Action[]

  @@map("features")
}

model ClassFeature {
  id            String  @id @default(uuid())
  classId       String
  featureId     String
  levelRequired Int     @default(1)
  class         Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  feature       Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([classId, featureId])
  @@map("class_features")
}

model ClassLevelProgression {
  id        String  @id @default(uuid())
  classId   String
  level     Int
  featureId String
  class     Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([classId, level, featureId])
  @@index([classId, level])
  @@map("class_level_progressions")
}

model Action {
  id              String        @id @default(uuid())
  name            String
  description     String?
  contentSourceId String
  featureId       String?
  rulesVersion    String        @default("v1")
  sourceRef       String?
  payloadType     String
  payloadJson     Json
  triggerJson     Json?
  contentSource   ContentSource @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  feature         Feature?      @relation(fields: [featureId], references: [id], onDelete: SetNull)

  @@index([featureId])
  @@index([payloadType])
  @@map("actions")
}

model Choice {
  id                    String                @id @default(uuid())
  contentSourceId       String
  rulesVersion          String                @default("v1")
  sourceRef             String?
  contentSource         ContentSource         @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  sourceType            String
  sourceId              String
  chooseCount           Int                   @default(1)
  optionsJson           Json
  characterChoices      CharacterChoice[]
  characterDraftChoices CharacterDraftChoice[]

  @@map("choices")
}

model Race {
  id              String         @id @default(uuid())
  name            String         @unique
  contentSourceId String
  rulesVersion    String         @default("v1")
  sourceRef       String?        @unique
  contentSource   ContentSource  @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  raceFeatures    RaceFeature[]
  characters      Character[]
  drafts          CharacterDraft[]

  @@map("races")
}

model Item {
  id              String         @id @default(uuid())
  name            String         @unique
  description     String?
  slot            String?
  weaponCategory  String?
  attackAbility   String?
  damageFormula   String?
  proficiencyRequirements Json?
  armorType       String?
  rulesVersion    String         @default("v1")
  sourceRef       String?
  contentSourceId String
  contentSource   ContentSource  @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  spells          Spell[]
  characterItems  CharacterItem[]

  @@map("items")
}

model CharacterItem {
  id          String    @id @default(uuid())
  characterId String
  itemId      String
  equipped    Boolean   @default(false)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  item        Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([characterId, itemId])
  @@map("character_items")
}

model Skill {
  id              String                        @id @default(uuid())
  name            String                        @unique
  ability         String
  contentSourceId String?
  contentSource   ContentSource?                @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  proficiencies   CharacterSkillProficiency[]

  @@map("skills")
}

model ClassSavingThrowProficiency {
  id        String @id @default(uuid())
  classId   String
  ability   String
  class     Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, ability])
  @@map("class_saving_throw_proficiencies")
}

model CharacterSkillProficiency {
  id          String     @id @default(uuid())
  characterId String
  skillId     String
  character   Character  @relation(fields: [characterId], references: [id], onDelete: Cascade)
  skill        Skill      @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([characterId, skillId])
  @@map("character_skill_proficiencies")
}

model RaceFeature {
  id        String  @id @default(uuid())
  raceId    String
  featureId String
  race      Race    @relation(fields: [raceId], references: [id], onDelete: Cascade)
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([raceId, featureId])
  @@map("race_features")
}

model Background {
  id              String         @id @default(uuid())
  name            String         @unique
  contentSourceId String
  rulesVersion    String         @default("v1")
  sourceRef       String?        @unique
  contentSource   ContentSource  @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  backgroundFeatures BackgroundFeature[]
  characters      Character[]
  drafts          CharacterDraft[]
  @@map("backgrounds")
}

model Modifier {
  id         String   @id @default(uuid())
  sourceType String
  sourceId   String
  target     String
  targetKey  String?
  operation  String
  value      Int?
  rulesVersion String @default("v1")
  sourceRef  String?
  createdAt  DateTime @default(now())

  @@index([sourceType, sourceId], name: "modifiers_source_idx")
  @@map("modifiers")
}

model Spell {
  id              String        @id @default(uuid())
  name            String        @unique
  description     String?
  level           Int?
  school          String?
  itemId          String?
  contentSourceId String
  rulesVersion    String        @default("v1")
  sourceRef       String?
  payloadType     String        @default("CUSTOM")
  payloadJson     Json?
  contentSource   ContentSource @relation(fields: [contentSourceId], references: [id], onDelete: Cascade)
  item            Item?         @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@index([itemId])
  @@map("spells")
}

model RuleDependency {
  id           String   @id @default(uuid())
  sourceRef    String
  sourceType   String?
  targetRef    String
  targetType   String?
  relationType String
  rulesVersion String   @default("v1")
  createdAt    DateTime @default(now())

  @@unique([sourceRef, targetRef, relationType])
  @@index([sourceRef, relationType])
  @@index([targetRef, relationType])
  @@map("rule_dependencies")
}

model BackgroundFeature {
  id           String     @id @default(uuid())
  backgroundId String
  featureId    String
  background   Background @relation(fields: [backgroundId], references: [id], onDelete: Cascade)
  feature      Feature    @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([backgroundId, featureId])
  @@map("background_features")
}

model AbilityScoreSet {
  id        String      @id @default(uuid())
  method    String      // "standard_array", "point_buy", "manual", "roll"
  str       Int
  dex       Int
  con       Int
  int       Int
  wis       Int
  cha       Int
  characters Character[]
  drafts    CharacterDraft[]

  @@map("ability_score_sets")
}

model Character {
  id               String             @id @default(uuid())
  name             String
  level            Int                @default(1)
  ownerUserId      String?
  classId          String
  raceId           String?
  backgroundId     String?
  abilityScoreSetId String?
  owner            User?              @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  class            Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  race             Race?              @relation(fields: [raceId], references: [id], onDelete: SetNull)
  background       Background?        @relation(fields: [backgroundId], references: [id], onDelete: SetNull)
  abilityScores    AbilityScoreSet?   @relation(fields: [abilityScoreSetId], references: [id], onDelete: SetNull)
  characterChoices CharacterChoice[]
  inventory        CharacterItem[]
  skillProficiencies CharacterSkillProficiency[]
  sessionCharacters SessionCharacter[]

  @@index([ownerUserId])
  @@map("characters")
}

model Session {
  id              String              @id @default(uuid())
  name            String
  gmUserId        String
  createdByUserId String
  joinCode        String              @unique
  initiativeLocked Boolean            @default(false) @map("initiative_locked")
  encounterActive Boolean             @default(false) @map("encounter_active")
  combatRound     Int                 @default(1) @map("combat_round")
  activeTurnSessionCharacterId String? @map("active_turn_session_character_id")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  gmUser          User                @relation("SessionGM", fields: [gmUserId], references: [id], onDelete: Cascade)
  createdByUser   User                @relation("SessionCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  players         SessionPlayer[]
  characters      SessionCharacter[]
  monsters        SessionMonster[]
  events          SessionEvent[]
  combatSnapshot  SessionCombatSnapshot?
  combatActions   SessionCombatAction[]
  reactionWindows SessionReactionWindow[]

  @@index([gmUserId])
  @@index([createdByUserId])
  @@map("sessions")
}

model MonsterTemplate {
  id                 String          @id @default(uuid())
  name               String
  size               String?
  creatureType       String?         @map("creature_type")
  alignment          String?
  armorClass         Int             @map("armor_class")
  maxHp              Int             @map("max_hp")
  hitDice            String?         @map("hit_dice")
  speed              String?
  strength           Int             @default(10)
  dexterity          Int             @default(10)
  constitution       Int             @default(10)
  intelligence       Int             @default(10)
  wisdom             Int             @default(10)
  charisma           Int             @default(10)
  initiativeModifier Int             @default(0) @map("initiative_modifier")
  challengeRating    String?         @map("challenge_rating")
  damageImmunities   String?         @map("damage_immunities")
  conditionImmunities String?        @map("condition_immunities")
  senses             String?
  languages          String?
  traits             String?
  actions            String?
  legendaryActions   String?         @map("legendary_actions")
  iconUrl            String?         @map("icon_url")
  imageUrl           String?         @map("image_url")
  source             String?
  scope              String          @default("PERSONAL")
  ownerUserId        String?         @map("owner_user_id")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  owner              User?           @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  sessionMonsters    SessionMonster[]

  @@index([scope])
  @@index([ownerUserId])
  @@map("monster_templates")
}

model SessionMonster {
  id                String           @id @default(uuid())
  sessionId         String
  monsterTemplateId String?          @map("monster_template_id")
  nameSnapshot      String           @map("name_snapshot")
  currentHp         Int              @map("current_hp")
  maxHpSnapshot     Int              @map("max_hp_snapshot")
  initiative        Int?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  session           Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  monsterTemplate   MonsterTemplate? @relation(fields: [monsterTemplateId], references: [id], onDelete: SetNull)
  effects           SessionMonsterEffect[]

  @@index([sessionId])
  @@index([monsterTemplateId])
  @@map("session_monsters")
}

model SessionMonsterEffect {
  id               String         @id @default(uuid())
  sessionMonsterId String         @map("session_monster_id")
  effectType       String         @map("effect_type")
  duration         String
  payload          Json
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  sessionMonster   SessionMonster @relation(fields: [sessionMonsterId], references: [id], onDelete: Cascade)

  @@index([sessionMonsterId])
  @@map("session_monster_effects")
}

model SessionEvent {
  id              String    @id @default(uuid())
  sessionId       String
  eventSeq        BigInt    @default(autoincrement()) @unique @map("event_seq")
  type            String
  eventCategory   String    @default("GENERAL") @map("event_category")
  message         String
  payload         Json?
  actorTelegramId String
  createdAt       DateTime  @default(now())
  session         Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([sessionId, eventSeq])
  @@map("session_events")
}

model SessionCombatSnapshot {
  id                        String   @id @default(uuid())
  sessionId                 String   @unique @map("session_id")
  encounterActive           Boolean  @default(false) @map("encounter_active")
  combatRound               Int      @default(1) @map("combat_round")
  activeTurnSessionCharacterId String? @map("active_turn_session_character_id")
  initiativeOrder           Json     @map("initiative_order")
  actors                    Json
  updatedAt                 DateTime @updatedAt @map("updated_at")
  session                   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, updatedAt])
  @@map("session_combat_snapshots")
}

model SessionCombatAction {
  id             String   @id @default(uuid())
  sessionId      String   @map("session_id")
  actorUserId    String   @map("actor_user_id")
  idempotencyKey String   @map("idempotency_key")
  actionType     String   @map("action_type")
  status         String   @default("completed")
  requestPayload Json     @map("request_payload")
  responsePayload Json?   @map("response_payload")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  session        Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, idempotencyKey])
  @@index([sessionId, createdAt])
  @@map("session_combat_actions")
}

model SessionReactionWindow {
  id               String   @id @default(uuid())
  sessionId        String   @map("session_id")
  targetType       String   @map("target_type")
  targetRefId      String   @map("target_ref_id")
  reactionType     String   @map("reaction_type")
  status           String   @default("PENDING")
  deadlineAt       DateTime @map("deadline_at")
  requestedByUserId String  @map("requested_by_user_id")
  resolvedByUserId String?  @map("resolved_by_user_id")
  responsePayload  Json?    @map("response_payload")
  resolvedAt       DateTime? @map("resolved_at")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  session          Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, status, deadlineAt])
  @@index([sessionId, targetType, targetRefId])
  @@map("session_reaction_windows")
}

model SessionPlayer {
  id        String      @id @default(uuid())
  sessionId String
  userId    String
  role      String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  session   Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([userId])
  @@map("session_players")
}

model SessionCharacter {
  id        String                 @id @default(uuid())
  sessionId String
  characterId String
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  session   Session                @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  character Character              @relation(fields: [characterId], references: [id], onDelete: Cascade)
  state     SessionCharacterState?
  effects   SessionEffect[]

  @@unique([sessionId, characterId])
  @@index([characterId])
  @@map("session_characters")
}

model SessionCharacterState {
  id                 String           @id @default(uuid())
  sessionCharacterId String           @unique
  currentHp          Int              @default(0)
  maxHpSnapshot      Int              @default(0)
  tempHp             Int?
  initiative         Int?
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  sessionCharacter   SessionCharacter @relation(fields: [sessionCharacterId], references: [id], onDelete: Cascade)

  @@map("session_character_states")
}

model SessionEffect {
  id                 String           @id @default(uuid())
  sessionCharacterId String
  effectType         String
  duration           String
  payload            Json
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  sessionCharacter   SessionCharacter @relation(fields: [sessionCharacterId], references: [id], onDelete: Cascade)

  @@index([sessionCharacterId])
  @@map("session_effects")
}

model StatusTemplate {
  id              String   @id @default(uuid())
  key             String   @unique
  name            String
  effectType      String   @map("effect_type")
  defaultDuration String   @map("default_duration")
  payload         Json
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("status_templates")
}

model CharacterChoice {
  id             String    @id @default(uuid())
  characterId    String
  choiceId       String
  selectedOption String
  character      Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  choice         Choice    @relation(fields: [choiceId], references: [id], onDelete: Cascade)

  @@unique([characterId, choiceId])
  @@map("character_choices")
}

model CharacterDraft {
  id                    String                @id @default(uuid())
  name                  String
  level                 Int                   @default(1)
  classId               String?
  raceId                String?
  backgroundId          String?
  abilityScoreSetId     String?
  class                 Class?                @relation(fields: [classId], references: [id], onDelete: SetNull)
  race                  Race?                 @relation(fields: [raceId], references: [id], onDelete: SetNull)
  background            Background?           @relation(fields: [backgroundId], references: [id], onDelete: SetNull)
  abilityScores         AbilityScoreSet?      @relation(fields: [abilityScoreSetId], references: [id], onDelete: SetNull)
  createdAt             DateTime              @default(now())
  characterDraftChoices CharacterDraftChoice[]

  @@map("character_drafts")
}

model CharacterDraftChoice {
  id             String         @id @default(uuid())
  draftId        String
  choiceId       String
  selectedOption String?
  draft          CharacterDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  choice         Choice         @relation(fields: [choiceId], references: [id], onDelete: Cascade)

  @@unique([draftId, choiceId])
  @@map("character_draft_choices")
}
